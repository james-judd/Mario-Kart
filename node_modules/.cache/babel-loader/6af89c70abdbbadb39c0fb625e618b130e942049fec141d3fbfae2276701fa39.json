{"ast":null,"code":"var _jsxFileName = \"/Users/jamesjudd/gluon/src/Race.js\",\n  _s = $RefreshSig$();\nimport { useEffect, useRef, useState } from \"react\";\nimport \"./App.css\";\nimport { RaceUI } from \"./RaceUI\";\nimport { Logo } from \"./Logo\";\nimport { characters } from \"./assets/mario_kart/characters/charactersStates\";\nimport { Countdown } from \"./Countdown\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nexport const Race = props => {\n  _s();\n  const getWindowSize = () => {\n    const {\n      innerWidth\n    } = window;\n    return {\n      innerWidth\n    };\n  };\n  let raceInProgress = null;\n  const [ordersArr, setOrdersArr] = useState([]);\n  const [raceProgress, setRaceProgress] = useState(0);\n  const [windowSize, setWindowSize] = useState(getWindowSize());\n  const [countdown, setCountdown] = useState(3);\n  const wsConnected = useRef(false);\n  useEffect(() => {\n    function handleWindowResize() {\n      setWindowSize(getWindowSize());\n    }\n    window.addEventListener(\"resize\", handleWindowResize);\n    return () => {\n      window.removeEventListener(\"resize\", handleWindowResize);\n    };\n  }, []);\n  const handleMessage = event => {\n    // console.log(ordersArr);\n    const parsed = JSON.parse(event.data);\n    const {\n      innerWidth\n    } = getWindowSize();\n    if (parsed.message && parsed.message.total_items_price) {\n      const totalGbpPrice = parsed.message.total_items_price.gbp_value;\n      const brand = parsed.message.property.channel;\n      const siteID = parsed.message.property.site_id;\n      setOrdersArr(prev => {\n        if (prev.length < 6 && prev.filter(e => e.brandName === brand).length === 0) {\n          const order = {\n            brandName: brand,\n            totalValue: 0,\n            characterName: characters[prev.length],\n            siteID: siteID,\n            logo: \"\"\n          };\n          return [...prev, order];\n        } else if (prev.length === 6 && prev.every(e => e.totalValue < innerWidth * 7)) {\n          const matchingOrder = prev.find(e => e.brandName === brand);\n          if (matchingOrder !== undefined) {\n            matchingOrder.totalValue = matchingOrder.totalValue + totalGbpPrice / 7;\n            return [...prev];\n          }\n        }\n        return [...prev];\n      });\n    }\n  };\n  useEffect(() => {\n    const socket = new WebSocket(\"wss://stable-incubator.thehut.net/cashboard-websocket-orders/?filter=orders\");\n    socket.addEventListener(\"message\", handleMessage);\n    socket.addEventListener(\"open\", () => wsConnected.current = true);\n    socket.onerror = () => {\n      console.log(\"Error with the websocket, reloading page\");\n      window.location.reload(true);\n    };\n    return () => {\n      if (wsConnected.current) {\n        console.log(\"connected\");\n      }\n    };\n    // eslint-disable-next-line\n  }, []);\n  useEffect(() => {\n    let timeout;\n    if (countdown > -1 && ordersArr.length === 6) {\n      timeout = setTimeout(() => {\n        console.log(\"countdown running\");\n        setCountdown(countdown => countdown - 1);\n      }, 1000);\n    }\n    return () => clearTimeout(timeout);\n    // eslint-disable-next-line\n  }, [countdown, ordersArr]);\n  useEffect(() => {\n    const finalPositions = ordersArr.sort(function (a, b) {\n      return b.totalValue - a.totalValue;\n    });\n    if (finalPositions.length === 6) {\n      const firstPlace = finalPositions[\"0\"];\n      const raceHasFinished = (firstPlace.totalValue + raceProgress) / 7 > windowSize.innerWidth;\n      if (raceHasFinished) {\n        console.log(\"the race has finished\");\n        props.setResults(finalPositions);\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [ordersArr, raceProgress, windowSize]);\n  if (countdown > -1 && ordersArr.length === 6) {\n    if (countdown === 0) {\n      return /*#__PURE__*/_jsxDEV(Countdown, {\n        text: \"Go!\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 126,\n        columnNumber: 14\n      }, this);\n    }\n    return /*#__PURE__*/_jsxDEV(Countdown, {\n      text: countdown\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 128,\n      columnNumber: 12\n    }, this);\n  }\n  if (ordersArr.length === 6) {\n    Logo(ordersArr);\n  } else {\n    return /*#__PURE__*/_jsxDEV(Countdown, {\n      text: \"Loading...\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 134,\n      columnNumber: 12\n    }, this);\n  }\n  if (ordersArr.length === 6) {\n    raceInProgress = true;\n    const finalPositions = ordersArr.sort(function (a, b) {\n      return b.totalValue - a.totalValue;\n    });\n    if (raceInProgress) {\n      setInterval(() => {\n        setRaceProgress(raceProgress => raceProgress + 0.005);\n      }, 10);\n    }\n    const firstPlace = finalPositions[\"0\"];\n    const raceHasFinished = (firstPlace.totalValue + raceProgress) / 7 > windowSize.innerWidth;\n    if (raceHasFinished) {\n      raceInProgress = false;\n    }\n    return /*#__PURE__*/_jsxDEV(RaceUI, {\n      raceProgress: raceProgress,\n      array: ordersArr,\n      totalGbpPrice: ordersArr.totalValue\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 159,\n      columnNumber: 7\n    }, this);\n  }\n};\n_s(Race, \"lvpfIR4eAsft4vuS2Kn8in8CmsA=\");\n_c = Race;\nvar _c;\n$RefreshReg$(_c, \"Race\");","map":{"version":3,"names":["useEffect","useRef","useState","RaceUI","Logo","characters","Countdown","Race","props","getWindowSize","innerWidth","window","raceInProgress","ordersArr","setOrdersArr","raceProgress","setRaceProgress","windowSize","setWindowSize","countdown","setCountdown","wsConnected","handleWindowResize","addEventListener","removeEventListener","handleMessage","event","parsed","JSON","parse","data","message","total_items_price","totalGbpPrice","gbp_value","brand","property","channel","siteID","site_id","prev","length","filter","e","brandName","order","totalValue","characterName","logo","every","matchingOrder","find","undefined","socket","WebSocket","current","onerror","console","log","location","reload","timeout","setTimeout","clearTimeout","finalPositions","sort","a","b","firstPlace","raceHasFinished","setResults","setInterval"],"sources":["/Users/jamesjudd/gluon/src/Race.js"],"sourcesContent":["import { useEffect, useRef, useState } from \"react\";\nimport \"./App.css\";\nimport { RaceUI } from \"./RaceUI\";\nimport { Logo } from \"./Logo\";\nimport { characters } from \"./assets/mario_kart/characters/charactersStates\";\nimport { Countdown } from \"./Countdown\";\n\nexport const Race = (props) => {\n  const getWindowSize = () => {\n    const { innerWidth } = window;\n    return { innerWidth };\n  };\n  let raceInProgress = null;\n  const [ordersArr, setOrdersArr] = useState([]);\n  const [raceProgress, setRaceProgress] = useState(0);\n  const [windowSize, setWindowSize] = useState(getWindowSize());\n  const [countdown, setCountdown] = useState(3);\n  const wsConnected = useRef(false);\n\n  useEffect(() => {\n    function handleWindowResize() {\n      setWindowSize(getWindowSize());\n    }\n\n    window.addEventListener(\"resize\", handleWindowResize);\n\n    return () => {\n      window.removeEventListener(\"resize\", handleWindowResize);\n    };\n  }, []);\n\n  const handleMessage = (event) => {\n    // console.log(ordersArr);\n    const parsed = JSON.parse(event.data);\n\n    const { innerWidth } = getWindowSize();\n\n    if (parsed.message && parsed.message.total_items_price) {\n      const totalGbpPrice = parsed.message.total_items_price.gbp_value;\n      const brand = parsed.message.property.channel;\n      const siteID = parsed.message.property.site_id;\n\n      setOrdersArr((prev) => {\n        if (\n          prev.length < 6 &&\n          prev.filter((e) => e.brandName === brand).length === 0\n        ) {\n          const order = {\n            brandName: brand,\n            totalValue: 0,\n            characterName: characters[prev.length],\n            siteID: siteID,\n            logo: \"\",\n          };\n\n          return [...prev, order];\n        } else if (\n          prev.length === 6 &&\n          prev.every((e) => e.totalValue < innerWidth * 7)\n        ) {\n          const matchingOrder = prev.find((e) => e.brandName === brand);\n          if (matchingOrder !== undefined) {\n            matchingOrder.totalValue =\n              matchingOrder.totalValue + totalGbpPrice / 7;\n\n            return [...prev];\n          }\n        }\n        return [...prev];\n      });\n    }\n  };\n  useEffect(() => {\n    const socket = new WebSocket(\n      \"wss://stable-incubator.thehut.net/cashboard-websocket-orders/?filter=orders\"\n    );\n    socket.addEventListener(\"message\", handleMessage);\n\n    socket.addEventListener(\"open\", () => (wsConnected.current = true));\n\n    socket.onerror = () => {\n      console.log(\"Error with the websocket, reloading page\");\n      window.location.reload(true);\n    };\n\n    return () => {\n      if (wsConnected.current) {\n        console.log(\"connected\");\n      }\n    };\n    // eslint-disable-next-line\n  }, []);\n\n  useEffect(() => {\n    let timeout;\n    if (countdown > -1 && ordersArr.length === 6) {\n      timeout = setTimeout(() => {\n        console.log(\"countdown running\");\n        setCountdown((countdown) => countdown - 1);\n      }, 1000);\n    }\n    return () => clearTimeout(timeout);\n    // eslint-disable-next-line\n  }, [countdown, ordersArr]);\n\n  useEffect(() => {\n    const finalPositions = ordersArr.sort(function (a, b) {\n      return b.totalValue - a.totalValue;\n    });\n\n    if (finalPositions.length === 6) {\n      const firstPlace = finalPositions[\"0\"];\n      const raceHasFinished =\n        (firstPlace.totalValue + raceProgress) / 7 > windowSize.innerWidth;\n\n      if (raceHasFinished) {\n        console.log(\"the race has finished\");\n        props.setResults(finalPositions);\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [ordersArr, raceProgress, windowSize]);\n\n  if (countdown > -1 && ordersArr.length === 6) {\n    if (countdown === 0) {\n      return <Countdown text=\"Go!\" />;\n    }\n    return <Countdown text={countdown} />;\n  }\n\n  if (ordersArr.length === 6) {\n    Logo(ordersArr);\n  } else {\n    return <Countdown text=\"Loading...\" />;\n  }\n\n  if (ordersArr.length === 6) {\n    raceInProgress = true;\n    const finalPositions = ordersArr.sort(function (a, b) {\n      return b.totalValue - a.totalValue;\n    });\n\n    if (raceInProgress) {\n      setInterval(() => {\n        setRaceProgress((raceProgress) => raceProgress + 0.005);\n      }, 10);\n    }\n\n    const firstPlace = finalPositions[\"0\"];\n\n    const raceHasFinished =\n      (firstPlace.totalValue + raceProgress) / 7 > windowSize.innerWidth;\n\n    if (raceHasFinished) {\n      raceInProgress = false;\n    }\n\n    return (\n      <RaceUI\n        raceProgress={raceProgress}\n        array={ordersArr}\n        totalGbpPrice={ordersArr.totalValue}\n      />\n    );\n  }\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}